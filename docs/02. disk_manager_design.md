# MiniDB 磁盘管理器设计文档

## 1. 概述

磁盘管理器（DiskManager）是MiniDB数据库系统的核心组件之一，负责管理数据库文件的创建、读取、写入和删除操作。它是数据库存储引擎的最底层组件，为上层组件提供页面级别的读写接口，使上层组件可以专注于数据结构和算法的实现，而不必关心底层的文件操作细节。

## 2. 设计目标

磁盘管理器的主要设计目标包括：

1. **抽象文件操作**：提供简单的页面级别接口，隐藏底层文件系统细节
2. **高效的I/O操作**：优化读写操作，减少I/O开销
3. **并发控制**：支持多线程环境下的安全访问
4. **错误处理**：提供健壮的错误检测和异常处理机制
5. **可扩展性**：设计良好的接口，便于未来扩展功能

## 3. 核心概念

### 3.1 页面（Page）

- **定义**：数据库文件的基本存储单位
- **大小**：固定为4KB（4096字节），可根据需要调整
- **标识**：每个页面有唯一的页面ID（page_id_t类型）
- **无效页面ID**：使用-1（INVALID_PAGE_ID）表示无效页面

### 3.2 页面偏移量

- 页面在文件中的位置由其ID决定：`offset = page_id * PAGE_SIZE`
- 这种简单的映射关系使得页面的定位非常高效

## 4. 类设计

### 4.1 DiskManager类

```cpp
class DiskManager {
public:
    explicit DiskManager(const std::string& db_file);
    ~DiskManager();
    
    void ReadPage(page_id_t page_id, char* page_data);
    void WritePage(page_id_t page_id, const char* page_data);
    page_id_t AllocatePage();
    void DeallocatePage(page_id_t page_id);
    size_t GetNumPages() const;
    void Close();
    void RemoveDBFile();

private:
    std::string db_file_name_;
    std::fstream db_io_;
    page_id_t next_page_id_;
    std::mutex mutex_;
    
    inline size_t PageOffset(page_id_t page_id) const;
};
```

### 4.2 成员变量

- **db_file_name_**：数据库文件名
- **db_io_**：文件流对象，用于文件操作
- **next_page_id_**：下一个可用的页面ID
- **mutex_**：互斥锁，用于并发控制

### 4.3 主要方法

#### 4.3.1 构造函数和析构函数

- **构造函数**：打开或创建数据库文件，初始化next_page_id_
- **析构函数**：关闭数据库文件

#### 4.3.2 页面操作

- **ReadPage**：读取指定ID的页面数据
- **WritePage**：写入数据到指定ID的页面
- **AllocatePage**：分配新的页面ID
- **DeallocatePage**：释放页面（标记为可重用）

#### 4.3.3 辅助方法

- **GetNumPages**：获取数据库文件的页面数量
- **Close**：关闭数据库文件
- **RemoveDBFile**：删除数据库文件
- **PageOffset**：计算页面在文件中的偏移量

## 5. 实现细节

### 5.1 文件管理

- 使用`std::fstream`进行文件操作
- 以二进制模式打开文件（`std::ios::binary`）
- 支持文件不存在时自动创建新文件

### 5.2 页面读取（ReadPage）

1. 使用互斥锁保护操作
2. 验证页面ID的有效性
3. 计算页面在文件中的偏移量
4. 检查页面是否超出文件范围，如果是则返回全零页面
5. 定位到页面位置并读取数据
6. 处理读取不足一个页面的情况，填充剩余部分为零

### 5.3 页面写入（WritePage）

1. 使用互斥锁保护操作
2. 验证页面ID的有效性
3. 计算页面在文件中的偏移量
4. 定位到页面位置并写入数据
5. 刷新到磁盘确保数据持久化
6. 更新next_page_id_（如果写入的页面ID大于等于当前next_page_id_）

### 5.4 页面分配（AllocatePage）

1. 使用互斥锁保护操作
2. 返回当前next_page_id_并递增

### 5.5 页面释放（DeallocatePage）

- 当前简化实现中不做实际操作
- 在更完整的实现中，可以维护一个空闲页面列表，将释放的页面添加到列表中以便重用

### 5.6 并发控制

- 使用`std::mutex`和`std::lock_guard`保护关键操作
- 确保在多线程环境下的安全访问

### 5.7 错误处理

- 使用自定义的`DBException`类处理异常情况
- 对各种可能的错误（如文件打开失败、读写错误等）进行检查和处理

## 6. 性能考虑

### 6.1 I/O优化

- 页面级别的读写减少了细粒度I/O操作的开销
- 固定大小的页面简化了内存管理

### 6.2 并发性能

- 使用互斥锁保护关键操作，但可能成为性能瓶颈
- 未来可考虑更细粒度的锁或无锁数据结构


## 7. 扩展性和未来改进

### 7.1 可能的改进

1. **空闲页面管理**：实现更高效的页面回收和重用机制
2. **异步I/O**：支持非阻塞的读写操作
3. **加锁**：在更高层次的缓冲池管理器中实现了锁定机制
当数据页被读入缓冲池时，会在缓冲池层面应用适当的锁定策略
4. **读写锁**：使用读写锁来允许多个读取操作同时进行

### 7.2 与其他组件的集成

磁盘管理器将与以下组件集成：

1. **缓冲池管理器**：提供页面缓存，减少磁盘I/O
2. **B+树索引**：使用页面存储索引节点
3. **表堆**：使用页面存储表数据
4. **日志管理器**：实现预写日志（WAL）以支持事务

